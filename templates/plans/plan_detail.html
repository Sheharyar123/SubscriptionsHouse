{% extends '_base.html' %}
{% load static %}

{% block title %}| {{ plan.title }}{% endblock title %}

{% block content %}
  <div class="background-container">
    <div class="container">
      <div class="row h-100 justify-content-center align-items-center">
        <div class="col-10 col-md-8 col-lg-6 form-margin">
            <div
            class="pricing_item text-center top40 wow fadeIn"
            data-wow-deeay="400ms"
            >
                <h3 class="font-light darkcolor"><b>{{ plan.title }}</b></h3>
                <div class="pricing_price darkcolor">
                    <span class="pricing_currency">
                    <b>${{ plan.price }}</b></span>/
                    {{ plan.valid_for }}
                </div>
                <p>{{ plan.description|safe|linebreaks }}</p>
                <div id="paypal-button-container"></div>
            </div>
          </div>
        </div>
    </div>
  </div>

  <script>
    const price = "{{ plan.price }}";
    {% comment %} const url = "{% url 'payments:check_payment' %}"; {% endcomment %}
    function initPayPalButton() {
      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'blue',
          layout: 'vertical',
          label: 'paypal',
          
        },
    
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{"amount":{"currency_code":"USD","value":price}}]
          });
        },
    
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(orderData) {
            
            // Full available details
            const transaction = orderData.purchase_units[0].payments.captures[0];
            console.log(transaction)
            const transaction_id = transaction.id;
            const status = transaction.status;
            send_transaction_data(transaction_id, status);
            // Show a success message within this page, e.g.
            const element = document.getElementById('paypal-button-container');
            element.innerHTML = '';
            element.innerHTML = '<h4 class="text-center"><i class="fa fa-spinner fa-spin"></i> Please wait...</h4>';
    
            // Or go to another URL:  actions.redirect('thank_you.html');
            
          });
        },
    
        onError: function(err) {
          console.log(err);
        }
      }).render('#paypal-button-container');
    }
    initPayPalButton();

    {% comment %} function send_transaction_data(transaction_id, status, payment_choice) {
      $.ajax({
          type: "POST",
          url: url,
          data: {
              order_number: order_number,
              transaction_id: transaction_id,
              status: status,
              payment_choice: payment_choice,
              csrfmiddlewaretoken: csrftoken,
          },
          success: function(response) {
              if (response.status == "success") {
                  window.location.href = `${order_complete_url}?order_number=${response.order_number}&trans_id=${response.transaction_id}`;
              }
          }
      }) {% endcomment %}
  {% comment %} } {% endcomment %}
  </script>

{% endblock content %}
